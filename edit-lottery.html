<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Modifica Lotteria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 16px;
    }

    h1, h2 {
      text-align: center;
      margin: 8px 0;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .card {
      background: #fff;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 14px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 12px;
      font-size: 14px;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      box-sizing: border-box;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .btn {
      width: 100%;
      padding: 12px;
      border-radius: 6px;
      border: none;
      font-size: 15px;
      cursor: pointer;
      margin-top: 12px;
    }

    .primary { background:#1e7e34; color:#fff; }
    .secondary { background:#6c757d; color:#fff; }

    .images {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-top: 8px;
    }

    .img-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .img-wrap img {
      height: 90px;
      width: 120px;
      object-fit: cover;
      border-radius: 8px;
      background: #eee;
    }

    .img-wrap button {
      padding: 6px 10px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      background: #dc3545;
      color: #fff;
      cursor: pointer;
    }

    .back {
      display: inline-block;
      margin-bottom: 10px;
      text-decoration: none;
      color: #333;
      font-size: 14px;
    }
  </style>
</head>

<body>
<div class="container">

  <a class="back" href="#" id="backBtn">‚Üê Torna a Gestisci</a>

  <h1>‚úèÔ∏è Modifica Lotteria</h1>

  <!-- DATI -->
  <div class="card">
    <h2>Dati principali</h2>

    <label>Titolo</label>
    <input id="title">

    <label>Descrizione</label>
    <textarea id="description"></textarea>

    <label>Prezzo biglietto (‚Ç¨)</label>
    <input id="ticket_price" type="number" min="1">

    <label>Data estrazione</label>
    <input id="draw_date" type="date">

    <label>Ruota</label>
    <select id="wheel">
      <option value="">‚Äî</option>
      <option>Bari</option>
      <option>Cagliari</option>
      <option>Firenze</option>
      <option>Genova</option>
      <option>Milano</option>
      <option>Napoli</option>
      <option>Palermo</option>
      <option>Roma</option>
      <option>Torino</option>
      <option>Venezia</option>
      <option>Nazionale</option>
    </select>

<div class="card">
  <h2>üí≥ Dati pagamento</h2>

  <label>PayPal username</label>
  <input id="paypal_user" placeholder="es. reimar2002">

  <label style="margin-top:12px;">Link Revolut</label>
  <input id="revolut_link" placeholder="es. https://revolut.me/tuonome">

  <div style="font-size:13px;color:#666;margin-top:10px;line-height:1.4;">
    Nota: i metodi compariranno agli utenti solo se il campo √® compilato.
  </div>
</div>

    <label>WhatsApp owner</label>
    <input id="whatsapp_contact" placeholder="+39 333 1234567">
  </div>

  <!-- IMMAGINI -->
  <div class="card">
    <h2>üì∑ Immagini premio</h2>

    <div id="imagesPreview" class="images"></div>

    <label>Aggiungi immagini (max 5 totali)</label>
    <input id="new_images" type="file" accept="image/*" multiple>
  </div>

  <!-- SALVA -->
  <div class="card">
    <button class="btn primary" onclick="saveChanges()">üíæ Salva modifiche</button>
    <button class="btn secondary" onclick="goBack()">Annulla</button>
  </div>

</div>

<script>
const SUPABASE_URL = "https://fkgxomjctgvbpvgfgfko.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrZ3hvbWpjdGd2YnB2Z2ZnZmtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTA4NjYsImV4cCI6MjA4MDYyNjg2Nn0.Ogun4Qs4zGosOOify0yKC4NgO9vy3QPtvy6F96zo6Gk";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const LOTTERY_ID = new URLSearchParams(location.search).get("id");

let CURRENT_IMAGES = [];

document.getElementById("backBtn").onclick = () => {
  location.href = `manage-lottery.html?id=${LOTTERY_ID}`;
};

function goBack() {
  location.href = `manage-lottery.html?id=${LOTTERY_ID}`;
}

async function requireAuth() {
  const { data } = await sb.auth.getUser();
  if (!data?.user) {
    location.href = "login.html";
    return null;
  }
  return data.user;
}

function renderImages() {
  const box = document.getElementById("imagesPreview");
  box.innerHTML = "";

  if (!CURRENT_IMAGES.length) {
    box.innerHTML = `<div style="color:#666;font-size:14px;">Nessuna immagine</div>`;
    return;
  }

  CURRENT_IMAGES.forEach((url, idx) => {
    const wrap = document.createElement("div");
    wrap.className = "img-wrap";
    wrap.innerHTML = `
      <img src="${url}">
      <button>Rimuovi</button>
    `;
    wrap.querySelector("button").onclick = () => {
      CURRENT_IMAGES.splice(idx, 1);
      renderImages();
    };
    box.appendChild(wrap);
  });
}

async function uploadNewImages() {
  const input = document.getElementById("new_images");
  const files = input.files;

  if (!files || !files.length) return;

  if (CURRENT_IMAGES.length + files.length > 5) {
    alert("Massimo 5 immagini totali");
    return;
  }

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const ext = file.name.split(".").pop();
    const path = `lotteries/${LOTTERY_ID}/${Date.now()}_${i}.${ext}`;

    const { error } = await sb.storage
      .from("lottery-images")
      .upload(path, file, { upsert: false });

    if (error) {
      alert("Errore upload immagine");
      return;
    }

    const { data } = sb.storage
      .from("lottery-images")
      .getPublicUrl(path);

    CURRENT_IMAGES.push(data.publicUrl);
  }

  input.value = "";
}

async function loadLottery() {
  const { data } = await sb
    .from("lotteries")
    .select("*")
    .eq("id", LOTTERY_ID)
    .maybeSingle();

  if (!data) {
    alert("Lotteria non trovata");
    return;
  }

  document.getElementById("title").value = data.title || "";
  document.getElementById("description").value = data.description || "";
  document.getElementById("ticket_price").value = data.ticket_price || "";
  document.getElementById("draw_date").value = data.draw_date || "";
  document.getElementById("wheel").value = data.wheel || "";
  document.getElementById("whatsapp_contact").value = data.whatsapp_contact || "";
  document.getElementById("paypal_user").value = data.paypal_user || "";
  document.getElementById("revolut_link").value = data.revolut_link || ""

  CURRENT_IMAGES = Array.isArray(data.prize_images) ? data.prize_images : [];
  renderImages();
}

async function saveChanges() {
  await uploadNewImages();

  const payload = {
    title: document.getElementById("title").value.trim(),
    description: document.getElementById("description").value.trim(),
    ticket_price: Number(document.getElementById("ticket_price").value),
    draw_date: document.getElementById("draw_date").value || null,
    wheel: document.getElementById("wheel").value || null,
    whatsapp_contact: document.getElementById("whatsapp_contact").value || null,
    prize_images: CURRENT_IMAGES,
    const paypal_user = document.getElementById("paypal_user").value.trim();
    const revolut_link = document.getElementById("revolut_link").value.trim();
  };

  const { error } = await sb
    .from("lotteries")
    .update(payload)
    .eq("id", LOTTERY_ID);

  if (error) {
    alert("Errore salvataggio");
    return;
  }

  alert("Modifiche salvate");
  goBack();
}

(async () => {
  const user = await requireAuth();
  if (!user) return;
  await loadLottery();
})();
</script>

</body>
</html>
