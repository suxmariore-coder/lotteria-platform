<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestisci Lotteria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 16px;
    }

    h1, h2 { text-align: center; margin: 6px 0; }

    .container { max-width: 600px; margin: 0 auto; }

    .header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .back {
      text-decoration: none;
      font-size: 14px;
      color: #333;
    }

    #statusMsg {
      text-align: center;
      color: #444;
      margin: 10px 0 14px;
      font-size: 14px;
    }

    /* STATUS */
    .status-banner {
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 12px;
    }
    .status-active { background: #e6f4ea; color: #1e7e34; }
    .status-closed { background: #fff3cd; color: #856404; }
    .status-finished { background: #f8d7da; color: #842029; }
    .status-archived { background: #e2e3e5; color: #41464b; }

    /* CARD */
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-size: 14px;
      margin-bottom: 6px;
    }

    .row span { color: #555; }
    .row b { color: #111; }

    /* BUTTONS */
    .btn {
      width: 100%;
      padding: 12px;
      border-radius: 6px;
      border: none;
      font-size: 15px;
      cursor: pointer;
      margin-top: 8px;
    }
    .primary { background: #1e7e34; color: #fff; }
    .secondary { background: #6c757d; color: #fff; }
    .warning { background: #ffc107; color: #333; }
    .disabled { opacity: .6; cursor: not-allowed; }

    /* IMAGES */
    .images {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .images img {
      height: 90px;
      width: 120px;
      border-radius: 8px;
      object-fit: cover;
      background: #eee;
      flex: 0 0 auto;
    }

    /* NUMBERS GRID */
    .grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .number {
      height: 52px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      overflow: hidden;
      box-sizing: border-box;
    }
    .available { background: #1e7e34; }
    .pending { background: #ffc107; color: #333; }
    .sold { background: #c82333; }

    .buyer {
      font-size: 11px;
      margin-top: 2px;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 0 4px;
      box-sizing: border-box;
    }

    @media (min-width: 768px) {
      .grid { grid-template-columns: repeat(10, 1fr); }
    }

    /* PAYMENTS LIST */
    .payment {
      font-size: 14px;
      border-bottom: 1px solid #eee;
      padding: 10px 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .payment:last-child { border-bottom: none; }

    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #f0f2f5;
      color: #333;
      width: fit-content;
    }
  </style>
</head>

<body>
<div class="container">

  <div class="header">
    <a class="back" href="dashboard.html">‚Üê Dashboard</a>
  </div>

  <h1 id="pageTitle">Gestisci Lotteria</h1>
  <div id="statusMsg"></div>

  <div id="statusBanner" class="status-banner" style="display:none;"></div>

  <!-- PANORAMICA -->
  <div class="card">
    <h2>Panoramica</h2>
    <div class="row"><span>Prezzo biglietto</span><b id="pTicket">‚Äî</b></div>
    <div class="row"><span>Data estrazione</span><b id="pDraw">‚Äî</b></div>
    <div class="row"><span>Ruota</span><b id="pWheel">‚Äî</b></div>
    <div class="row"><span>Venduti</span><b id="pSold">‚Äî</b></div>
    <div class="row"><span>In attesa</span><b id="pPending">‚Äî</b></div>
  </div>

  <!-- MODIFICA (solo UI, agganceremo dopo) -->
  <div class="card">
    <h2>Azioni</h2>
    <button class="btn secondary disabled" disabled>‚úèÔ∏è Modifica dati (step successivo)</button>
    <button class="btn warning disabled" disabled>‚õî Chiudi vendite (step successivo)</button>
  </div>

  <!-- IMMAGINI -->
  <div class="card">
    <h2>Immagini premio</h2>
    <div id="imagesBox" class="images"></div>
    <button class="btn secondary disabled" disabled>‚ûï Gestisci immagini (step successivo)</button>
  </div>

  <!-- NUMERI -->
  <div class="card">
    <h2>Numeri</h2>
    <div id="numbersGrid" class="grid"></div>
  </div>

  <!-- PAGAMENTI PENDING -->
  <div class="card">
    <h2>Pagamenti in attesa</h2>
    <div id="pendingList"></div>
    <button class="btn primary disabled" disabled>‚úÖ Conferma pagamento (step successivo)</button>
  </div>

</div>

<script>
  // ‚úÖ CONFIG
  const SUPABASE_URL = "https://fkgxomjctgvbpvgfgfko.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrZ3hvbWpjdGd2YnB2Z2ZnZmtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTA4NjYsImV4cCI6MjA4MDYyNjg2Nn0.Ogun4Qs4zGosOOify0yKC4NgO9vy3QPtvy6F96zo6Gk";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const LOTTERY_ID = new URLSearchParams(location.search).get("id");

  const elStatusMsg = document.getElementById("statusMsg");
  const elStatusBanner = document.getElementById("statusBanner");

  const elTicket = document.getElementById("pTicket");
  const elDraw = document.getElementById("pDraw");
  const elWheel = document.getElementById("pWheel");
  const elSold = document.getElementById("pSold");
  const elPending = document.getElementById("pPending");

  const elImagesBox = document.getElementById("imagesBox");
  const elNumbersGrid = document.getElementById("numbersGrid");
  const elPendingList = document.getElementById("pendingList");

  function fmtDateIT(dateStr) {
    if (!dateStr) return "‚Äî";
    const d = new Date(dateStr);
    if (Number.isNaN(d.getTime())) return "‚Äî";
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  function setBanner(status) {
    elStatusBanner.style.display = "block";

    const cls =
      status === "active" ? "status-active" :
      status === "closed" ? "status-closed" :
      status === "archived" ? "status-archived" :
      "status-finished";

    elStatusBanner.className = `status-banner ${cls}`;

    elStatusBanner.textContent =
      status === "active" ? "‚úÖ Lotteria attiva" :
      status === "closed" ? "‚õî Vendite chiuse" :
      status === "archived" ? "üóÇÔ∏è Lotteria archiviata" :
      "üèÅ Lotteria conclusa";
  }

  async function requireAuth() {
    const { data, error } = await sb.auth.getUser();
    if (error || !data?.user) {
      location.href = "login.html";
      return null;
    }
    return data.user;
  }

  async function loadLottery(ownerId) {
    elStatusMsg.textContent = "Caricamento lotteria‚Ä¶";

    // Nota: selezioniamo solo ci√≤ che serve (aggiungerai campi dopo)
    const { data, error } = await sb
      .from("lotteries")
      .select("id,title,description,ticket_price,draw_date,wheel,status,prize_images,owner_id")
      .eq("id", LOTTERY_ID)
      .maybeSingle();

    if (error || !data) {
      elStatusMsg.textContent = "Lotteria non trovata.";
      return null;
    }

    if (data.owner_id !== ownerId) {
      elStatusMsg.textContent = "Non hai accesso a questa lotteria.";
      return null;
    }

    document.getElementById("pageTitle").textContent = `Gestisci: ${data.title || "Lotteria"}`;
    elTicket.textContent = data.ticket_price != null ? `‚Ç¨ ${data.ticket_price}` : "‚Äî";
    elDraw.textContent = fmtDateIT(data.draw_date);
    elWheel.textContent = data.wheel || "‚Äî";
    setBanner(data.status || "active");

    // immagini
    elImagesBox.innerHTML = "";
    const imgs = Array.isArray(data.prize_images) ? data.prize_images : [];
    if (!imgs.length) {
      elImagesBox.innerHTML = `<div style="color:#666;font-size:14px;">Nessuna immagine</div>`;
    } else {
      imgs.forEach(url => {
        const img = document.createElement("img");
        img.src = url;
        img.alt = "premio";
        img.onclick = () => window.open(url, "_blank");
        elImagesBox.appendChild(img);
      });
    }

    elStatusMsg.textContent = "";
    return data;
  }

  async function loadNumbersAndPending() {
    elNumbersGrid.innerHTML = "";
    elPendingList.innerHTML = `<div style="color:#666;font-size:14px;">Caricamento‚Ä¶</div>`;

    const { data, error } = await sb
      .from("lottery_numbers")
      .select("id,number,status,payment_status,pending_buyer_name,buyer_name,payment_method")
      .eq("lottery_id", LOTTERY_ID)
      .order("number", { ascending: true });

    if (error || !Array.isArray(data)) {
      elPendingList.innerHTML = `<div style="color:#c00;font-size:14px;">Errore caricamento numeri.</div>`;
      return;
    }

    let soldCount = 0;
    let pendingCount = 0;

    // render griglia
    data.forEach(row => {
      const cls = row.status === "sold"
        ? "sold"
        : row.payment_status === "pending"
        ? "pending"
        : "available";


if (cls === "sold") {
  d.style.cursor = "pointer";
  d.onclick = () => askResetNumber(row.id, row.number);
}

      const d = document.createElement("div");
      d.className = `number ${cls}`;
      d.innerHTML = `
        <div>${row.number}</div>
        ${
          cls === "pending"
            ? `<div class="buyer">‚è≥ ${row.pending_buyer_name || ""}</div>`
            : cls === "sold"
            ? `<div class="buyer">${row.buyer_name || ""}</div>`
            : ``
        }
      `;
      elNumbersGrid.appendChild(d);
    });

    elSold.textContent = `${soldCount} / 90`;
    elPending.textContent = `${pendingCount}`;

    // lista pending
    const pendings = data.filter(r => r.payment_status === "pending");
    if (!pendings.length) {
      elPendingList.innerHTML = `<div style="color:#666;font-size:14px;">Nessun pagamento in attesa.</div>`;
      return;
    }

    elPendingList.innerHTML = "";
    pendings.forEach(p => {
  const div = document.createElement("div");
  div.className = "payment";
  div.innerHTML = `
    <div><b>${p.pending_buyer_name || "‚Äî"}</b> ‚Äì Numero <b>${p.number}</b></div>
    <div class="pill">Metodo: ${(p.payment_method || "manuale").toUpperCase()}</div>

    <div style="display:flex;gap:8px;margin-top:6px;">
      <button class="btn primary" style="flex:1" onclick="handlePayment('${p.id}','confirm')">
        ‚úÖ Conferma
      </button>
      <button class="btn secondary" style="flex:1" onclick="handlePayment('${p.id}','reject')">
        ‚ùå Rifiuta
      </button>
    </div>
  `;
  elPendingList.appendChild(div);
});

  }

  (async () => {
    if (!LOTTERY_ID) {
      elStatusMsg.textContent = "ID lotteria mancante nell‚ÄôURL.";
      return;
    }

    const user = await requireAuth();
    if (!user) return;

    const lot = await loadLottery(user.id);
    if (!lot) return;

    await loadNumbersAndPending();
  })();

async function handlePayment(numberId, action) {
  if (!confirm(action === "confirm"
      ? "Confermare questo pagamento?"
      : "Rifiutare e liberare il numero?"
  )) return;

  const { data: { session } } = await sb.auth.getSession();
  if (!session) {
    alert("Sessione scaduta");
    return;
  }

  const res = await fetch(
    `${SUPABASE_URL}/functions/v1/confirm-payment`,
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${session.access_token}`,
      },
      body: JSON.stringify({
        number_id: numberId,
        action,
      }),
    }
  );

  const data = await res.json();
  if (!res.ok) {
    alert(data.error || "Errore operazione");
    return;
  }

  // üîÑ refresh dati
  await loadNumbersAndPending();
}

async function askResetNumber(numberId, numberLabel) {
  const pwd = prompt(
    `Inserisci la password admin per resettare il numero ${numberLabel}:`
  );
  if (!pwd) return;

  const { data: { session } } = await sb.auth.getSession();
  if (!session) {
    alert("Sessione scaduta");
    return;
  }

  const res = await fetch(
    `${SUPABASE_URL}/functions/v1/reset-number`,
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${session.access_token}`,
      },
      body: JSON.stringify({
        number_id: numberId,
        admin_password: pwd,
      }),
    }
  );

  const data = await res.json();
  if (!res.ok) {
    alert(data.error || "Errore reset numero");
    return;
  }

  alert("Numero resettato correttamente");
  loadNumbersAndPending();
}

</script>

</body>
</html>
