<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Gestione Lotteria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin: auto;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
    }

    .info {
      margin: 10px 0;
      color: #333;
    }

    .status {
      font-weight: bold;
      margin-top: 10px;
    }

    .status.active { color: green; }
    .status.closed { color: red; }

    button {
      width: 100%;
      margin-top: 20px;
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .close-btn {
      background: #dc3545;
      color: #fff;
    }

    .close-btn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }

    .back {
      background: #6c757d;
      color: #fff;
      margin-top: 10px;
    }
  </style>
</head>

<body>

<div class="container">
  <h2>‚öôÔ∏è Gestione Lotteria</h2>

  <div class="info"><strong>Titolo:</strong> <span id="title"></span></div>
  <div class="info"><strong>Data estrazione:</strong> <span id="draw_date"></span></div>
  <div class="info status" id="status"></div>

  <button id="closeBtn" class="close-btn" onclick="closeLottery()">
    üîí Chiudi definitivamente la lotteria
  </button>

  <button class="back" onclick="goBack()">‚¨ÖÔ∏è Torna alla dashboard</button>
</div>

<script>
/* CONFIG */
const SUPABASE_URL = "https://fkgxomjctgvbpvgfgfko.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrZ3hvbWpjdGd2YnB2Z2ZnZmtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTA4NjYsImV4cCI6MjA4MDYyNjg2Nn0.Ogun4Qs4zGosOOify0yKC4NgO9vy3QPtvy6F96zo6Gk";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* LOTTERY ID */
const params = new URLSearchParams(window.location.search);
const LOTTERY_ID = params.get("id");

if (!LOTTERY_ID) {
  document.body.innerHTML = "<h2>ID lotteria mancante</h2>";
  throw new Error("Missing lottery id");
}

let LOTTERY_STATUS = "active";

/* AUTH CHECK */
async function checkAuth() {
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (!session) {
    window.location.href = "login.html";
    return;
  }
  loadLottery();
}

/* LOAD LOTTERY */
async function loadLottery() {
  const { data, error } = await supabaseClient
    .from("lotteries")
    .select("title, draw_date, status")
    .eq("id", LOTTERY_ID)
    .single();

  if (error || !data) {
    alert("Errore caricamento lotteria");
    return;
  }

  document.getElementById("title").textContent = data.title;
  document.getElementById("draw_date").textContent = data.draw_date || "‚Äî";

  LOTTERY_STATUS = data.status || "active";

  const statusEl = document.getElementById("status");
  statusEl.textContent =
    LOTTERY_STATUS === "active"
      ? "üü¢ Lotteria attiva"
      : "üî¥ Lotteria chiusa";

  statusEl.className = "info status " + LOTTERY_STATUS;

  if (LOTTERY_STATUS !== "active") {
    document.getElementById("closeBtn").disabled = true;
  }
}

/* CLOSE LOTTERY */
async function closeLottery() {
  const ok = confirm(
    "Sei sicuro? Questa operazione √® DEFINITIVA.\nNon potrai pi√π vendere o resettare numeri."
  );
  if (!ok) return;

  const { error } = await supabaseClient
    .from("lotteries")
    .update({ status: "closed" })
    .eq("id", LOTTERY_ID);

  if (error) {
    alert("Errore chiusura lotteria");
    return;
  }

  alert("Lotteria chiusa con successo");
  loadLottery();
}

/* BACK */
function goBack() {
  window.location.href = "dashboard.html";
}

/* INIT */
checkAuth();
</script>

</body>
</html>
