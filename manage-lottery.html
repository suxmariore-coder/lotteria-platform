<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Gestione Lotteria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }

    .container {
      max-width: 520px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin: auto;
    }

    h2, h3 {
      text-align: center;
    }

    .info {
      margin: 10px 0;
      color: #333;
    }

    .status {
      font-weight: bold;
      margin-top: 10px;
    }

    .status.active { color: green; }
    .status.closed { color: red; }

    button {
      width: 100%;
      margin-top: 12px;
      padding: 12px;
      font-size: 15px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .close-btn {
      background: #dc3545;
      color: #fff;
    }

    .close-btn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }

    .back {
      background: #6c757d;
      color: #fff;
    }

    .pending-box {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      background: #fafafa;
    }

    .pending-box button {
      margin-top: 6px;
      width: 48%;
    }

    .confirm {
      background: #1e7e34;
      color: white;
    }

    .cancel {
      background: #dc3545;
      color: white;
    }

    .row {
      display: flex;
      justify-content: space-between;
      gap: 4%;
    }
  </style>
</head>

<body>

<div class="container">
  <h2>‚öôÔ∏è Gestione Lotteria</h2>

  <div class="info"><strong>Titolo:</strong> <span id="title"></span></div>
  <div class="info"><strong>Data estrazione:</strong> <span id="draw_date"></span></div>
  <div class="info status" id="status"></div>

  <button id="closeBtn" class="close-btn" onclick="closeLottery()">
    üîí Chiudi definitivamente la lotteria
  </button>

  <hr style="margin:20px 0">

  <h3>üìä Vendite</h3>
  <div class="info"><strong>Numeri venduti:</strong> <span id="soldCount">0</span></div>
  <div class="info"><strong>Numeri in attesa:</strong> <span id="pendingCount">0</span></div>
  <div class="info"><strong>Numeri disponibili:</strong> <span id="availableCount">0</span></div>

  <hr style="margin:20px 0">

  <h3>üí∞ Incassi</h3>
  <div class="info"><strong>Incasso confermato:</strong> ‚Ç¨ <span id="revenuePaid">0</span></div>
  <div class="info"><strong>Incasso potenziale:</strong> ‚Ç¨ <span id="revenuePending">0</span></div>
  <div class="info"><strong>Totale:</strong> ‚Ç¨ <span id="revenueTotal">0</span></div>

  <hr style="margin:20px 0">

  <h3>‚è≥ Pagamenti manuali in attesa</h3>
  <div id="pendingList"></div>

  <button class="back" onclick="goBack()">‚¨ÖÔ∏è Torna alla dashboard</button>
</div>

<script>
/* CONFIG */
const SUPABASE_URL = "https://fkgxomjctgvbpvgfgfko.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrZ3hvbWpjdGd2YnB2Z2ZnZmtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTA4NjYsImV4cCI6MjA4MDYyNjg2Nn0.Ogun4Qs4zGosOOify0yKC4NgO9vy3QPtvy6F96zo6Gk";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* LOTTERY ID */
const params = new URLSearchParams(window.location.search);
const LOTTERY_ID = params.get("id");

if (!LOTTERY_ID) {
  document.body.innerHTML = "<h2>ID lotteria mancante</h2>";
  throw new Error("Missing lottery id");
}

let LOTTERY_STATUS = "active";

/* AUTH */
async function checkAuth() {
  const { data } = await sb.auth.getSession();
  if (!data.session) {
    window.location.href = "login.html";
    return;
  }
  await loadLottery();
  await loadSalesStats();
  await loadPendingNumbers();
}

/* LOAD LOTTERY */
async function loadLottery() {
  const { data, error } = await sb
    .from("lotteries")
    .select("title, draw_date, status")
    .eq("id", LOTTERY_ID)
    .single();

  if (error || !data) {
    alert("Errore caricamento lotteria");
    return;
  }

  document.getElementById("title").textContent = data.title;
  document.getElementById("draw_date").textContent = data.draw_date || "‚Äî";

  LOTTERY_STATUS = data.status || "active";

  const statusEl = document.getElementById("status");
  statusEl.textContent =
    LOTTERY_STATUS === "active"
      ? "üü¢ Lotteria attiva"
      : "üî¥ Lotteria chiusa";

  statusEl.className = "info status " + LOTTERY_STATUS;

  if (LOTTERY_STATUS !== "active") {
    document.getElementById("closeBtn").disabled = true;
  }
}

/* SALES STATS */
async function loadSalesStats() {
  const { data: lottery } = await sb
    .from("lotteries")
    .select("ticket_price")
    .eq("id", LOTTERY_ID)
    .single();

  if (!lottery) return;
  const price = Number(lottery.ticket_price);

  const { data: numbers } = await sb
    .from("lottery_numbers")
    .select("status, payment_status")
    .eq("lottery_id", LOTTERY_ID);

  let sold = 0;
  let pending = 0;
  let available = 0;

  numbers.forEach(n => {
    if (n.status === "sold") sold++;
    else if (n.payment_status === "pending") pending++;
    else available++;
  });

  document.getElementById("soldCount").textContent = sold;
  document.getElementById("pendingCount").textContent = pending;
  document.getElementById("availableCount").textContent = available;

  document.getElementById("revenuePaid").textContent = (sold * price).toFixed(2);
  document.getElementById("revenuePending").textContent = (pending * price).toFixed(2);
  document.getElementById("revenueTotal").textContent =
    ((sold + pending) * price).toFixed(2);
}

/* PENDING NUMBERS */
async function loadPendingNumbers() {
  const { data } = await sb
    .from("lottery_numbers")
    .select("id, number, pending_buyer_name, payment_method")
    .eq("lottery_id", LOTTERY_ID)
    .eq("payment_status", "pending")
    .order("number");

  const box = document.getElementById("pendingList");
  box.innerHTML = "";

  if (!data || data.length === 0) {
    box.innerHTML = "<p>Nessun pagamento in attesa.</p>";
    return;
  }

  data.forEach(n => {
    const div = document.createElement("div");
    div.className = "pending-box";
    div.innerHTML = `
      <b>Numero ${n.number}</b><br>
      üë§ ${n.pending_buyer_name}<br>
      üí≥ ${n.payment_method}
      <div class="row">
        <button class="confirm" onclick="confirmManual('${n.id}')">‚úÖ Conferma</button>
        <button class="cancel" onclick="cancelManual('${n.id}')">‚ùå Annulla</button>
      </div>
    `;
    box.appendChild(div);
  });
}

/* CONFIRM */
async function confirmManual(id) {
  if (!confirm("Confermi pagamento ricevuto?")) return;

  const { data } = await sb
    .from("lottery_numbers")
    .select("pending_buyer_name")
    .eq("id", id)
    .single();

  await sb
    .from("lottery_numbers")
    .update({
      status: "sold",
      buyer_name: data.pending_buyer_name,
      payment_status: "paid",
      pending_buyer_name: null
    })
    .eq("id", id);

  await loadSalesStats();
  await loadPendingNumbers();
}

/* CANCEL */
async function cancelManual(id) {
  if (!confirm("Annullare la prenotazione?")) return;

  await sb
    .from("lottery_numbers")
    .update({
      status: "available",
      payment_status: null,
      pending_buyer_name: null
    })
    .eq("id", id);

  await loadSalesStats();
  await loadPendingNumbers();
}

/* CLOSE LOTTERY */
async function closeLottery() {
  if (!confirm("Sei sicuro? Questa operazione √® DEFINITIVA.")) return;

  await sb
    .from("lotteries")
    .update({ status: "closed" })
    .eq("id", LOTTERY_ID);

  alert("Lotteria chiusa");
  await loadLottery();
}

/* BACK */
function goBack() {
  window.location.href = "dashboard.html";
}

/* INIT */
checkAuth();
</script>

</body>
</html>
