<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Lotteria</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  font-family: Arial, sans-serif;
  padding: 16px;
  background: #f5f5f5;
  margin: 0;
}

h1, h3 { text-align: center; margin: 6px 0; }

#lottery-meta {
  text-align: center;
  color: #555;
  margin-bottom: 10px;
  white-space: pre-line;
}

.status-banner {
  max-width: 600px;
  margin: 12px auto;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  font-weight: bold;
}

.status-active { background: #e6f4ea; color: #1e7e34; }
.status-closed { background: #fff3cd; color: #856404; }
.status-finished { background: #f8d7da; color: #842029; }

.share-box {
  max-width: 600px;
  margin: 10px auto 16px;
  display: flex;
  justify-content: center;
  gap: 12px;
  flex-wrap: wrap;
}

@media (max-width:600px){
  .share-box { flex-wrap: nowrap; }
  .share-box .btn { flex:1; max-width:48%; }
}

.btn {
  padding: 12px;
  border-radius: 6px;
  border: none;
  font-size: 15px;
  cursor: pointer;
}

.whatsapp { background:#25D366; color:#fff; }
.stripe { background:#6772e5; color:#fff; }
.paypal { background:#003087; color:#fff; }
.revolut { background:#111; color:#fff; }
.cancel { background:#ddd; }

.gallery {
  display:flex;
  gap:10px;
  overflow-x:auto;
  padding:10px 0;
  max-width:600px;
  margin:0 auto 16px;
}

.gallery img {
  height:220px;
  border-radius:10px;
  cursor:pointer;
}

#lottery-description {
  background:#fff;
  padding:12px;
  border-radius:8px;
  max-width:600px;
  margin:12px auto;
  text-align:center;
}

.grid {
  display:grid;
  grid-template-columns:repeat(10,1fr);
  gap:10px;
}

@media (max-width:600px){
  .grid { grid-template-columns:repeat(6,1fr); }
}

.number {
  height:64px;
  border-radius:8px;
  font-weight:bold;
  color:#fff;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  overflow:hidden;
}

.available { background:#1e7e34; cursor:pointer; }
.sold { background:#c82333; cursor:not-allowed; opacity:.85; }
.pending { background:#ffc107; color:#333; cursor:not-allowed; }

.buyer {
  font-size:11px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:100%;
}

.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}

.modal.show { display:flex; }

.modal-content {
  background:#fff;
  width:100%;
  max-width:380px;
  border-radius:12px;
  padding:20px;
}
</style>
</head>

<body>

<h1 id="lottery-title"></h1>
<h3 id="lottery-price"></h3>
<p id="lottery-meta"></p>

<div class="share-box">
  <button class="btn whatsapp" onclick="shareWhatsapp()">Condividi LotteRiffa</button>
  <button class="btn" style="background:#000;color:#fff" onclick="goToCreateLottery()">‚ú® Crea la tua Lotteriffa</button>
</div>

<div id="lottery-status-banner" style="display:none"></div>
<div id="prize-gallery" class="gallery"></div>

<div id="lottery-description">
  <strong>üéÅ Premio in palio</strong><br><br>
  <span id="lottery-description-text"></span>
</div>

<div id="grid" class="grid"></div>

<div id="modal" class="modal"><div class="modal-content"></div></div>

<script>
const SUPABASE_URL="https://fkgxomjctgvbpvgfgfko.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrZ3hvbWpjdGd2YnB2Z2ZnZmtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTA4NjYsImV4cCI6MjA4MDYyNjg2Nn0.Ogun4Qs4zGosOOify0yKC4NgO9vy3QPtvy6F96zo6Gk";
const LOTTERY_ID=new URLSearchParams(location.search).get("id");

const grid=document.getElementById("grid");
const modal=document.getElementById("modal");
const modalContent=document.querySelector(".modal-content");

let currentRow=null;
window.LOTTERY_EXPIRED=false;

const originalModalHTML=`
<h3 id="modalTitle"></h3>
<input id="nameField" placeholder="Il tuo nome"/>
<button class="btn stripe" onclick="payWithStripe()">Stripe</button>
<button class="btn paypal" onclick="payManual('paypal')">PayPal</button>
<button class="btn revolut" onclick="payManual('revolut')">Revolut</button>
<button class="btn cancel" onclick="closeModal()">Annulla</button>
`;

function shareWhatsapp(){
  window.open("https://wa.me/?text="+encodeURIComponent(location.href),"_blank");
}
function goToCreateLottery(){ location.href="login.html"; }

async function loadLottery(){
  const r=await fetch(`${SUPABASE_URL}/rest/v1/lotteries?id=eq.${LOTTERY_ID}&select=*`,{headers:{apikey:SUPABASE_ANON_KEY}});
  const [lot]=await r.json(); if(!lot) return;

  document.getElementById("lottery-title").textContent=lot.title;
  document.getElementById("lottery-price").textContent=`Prezzo biglietto: ‚Ç¨ ${lot.ticket_price}`;
  document.getElementById("lottery-description-text").textContent=lot.description||"";

  const meta=[];
  if(lot.draw_date){
    const d=new Date(lot.draw_date); d.setHours(0,0,0,0);
    const t=new Date(); t.setHours(0,0,0,0);
    window.LOTTERY_EXPIRED = t>d;
    meta.push(`üìÖ Estrazione: ${d.toLocaleDateString("it-IT")}`);
  }
  if(lot.wheel) meta.push(`üé° Ruota: ${lot.wheel}`);
  document.getElementById("lottery-meta").textContent=meta.join("\n");

  const banner=document.getElementById("lottery-status-banner");
  banner.style.display="block";
  banner.className="status-banner "+(window.LOTTERY_EXPIRED?"status-finished":"status-active");
  banner.textContent=window.LOTTERY_EXPIRED?"üèÅ Lotteria conclusa":"‚úÖ Lotteria attiva";

  renderGallery(lot.prize_images);
}

function renderGallery(images){
  const g=document.getElementById("prize-gallery");
  g.innerHTML="";
  if(!images) return;
  (Array.isArray(images)?images:JSON.parse(images)).forEach(u=>{
    const i=document.createElement("img"); i.src=u; g.appendChild(i);
  });
}

async function loadNumbers(){
  const r=await fetch(`${SUPABASE_URL}/rest/v1/lottery_numbers?lottery_id=eq.${LOTTERY_ID}&order=number.asc`,
    {headers:{apikey:SUPABASE_ANON_KEY}});
  const data=await r.json(); grid.innerHTML="";

  data.forEach(row=>{
    const d=document.createElement("div");
    const cls=row.status==="sold"?"sold":row.payment_status==="pending"?"pending":"available";
    d.className=`number ${cls}`;
    d.innerHTML=`<div>${row.number}</div>${row.buyer_name?`<div class="buyer">${row.buyer_name}</div>`:""}`;
    if(cls==="available" && !window.LOTTERY_EXPIRED) d.onclick=()=>openModal(row);
    grid.appendChild(d);
  });
}

function openModal(row){
  currentRow=row;
  modalContent.innerHTML=originalModalHTML;
  modalContent.querySelector("#modalTitle").textContent=`Numero ${row.number}`;
  modal.classList.add("show");
}
function closeModal(){ modal.classList.remove("show"); currentRow=null; }

async function payWithStripe(){ alert("Stripe OK"); }
async function payManual(){ alert("Manual OK"); }

loadLottery();
loadNumbers();
</script>
</body>
</html>
